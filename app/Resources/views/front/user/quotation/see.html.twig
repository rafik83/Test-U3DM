{% extends 'front/user/base.html.twig' %}

{% block user_content %}
    
   {% if  quotation.status == constant('\\AppBundle\\Entity\\Quotation::STATUS_ACCEPTED') %}
        <h1>Votre Projet {{ quotation.project.reference }} - {{ quotation.project.name }}</h1>
        
            <div class="row">
                <div class="col-sm-3"><strong><p>Type de projet :</p></strong></div>
                <div class="col-sm-9">{{ quotation.project.type.name }}</div>
            </div>
            <div class="row">
                <div class="col-sm-3"><strong><p>Description :</p></strong></div>
                <div class="col-sm-9"> {{ quotation.project.description |nl2br}}</div>
            </div>
            <div class="row">
                <div class="col-sm-3"><strong><p>Application(s) :</p></strong></div>
                <div class="col-sm-9">
                    {% for field in quotation.project.fields %}
                        {{field.name}}</b>
                    {% endfor %}
                </div>
            </div>
        

    {% endif %}


    {# DISPLAY QUOTATION #}
 
        <div class="row">
            <div class="col-sm-6 text-left"> <h2>Devis {{ quotation.reference }} du {{ quotation.savedAt|date('d/m/Y', 'Europe/Paris') }}</h2></div>
            <div class="col-sm-6 text-right"> <a href="{{ path('quotation_download', { 'reference': quotation.reference }) }}" class="btn btn-sm">Télécharger le devis</a></div>
        </div>


    {% if  quotation.status != constant('\\AppBundle\\Entity\\Quotation::STATUS_ACCEPTED') %}
        <p><a href="{{ path('design_form', {'reference': quotation.project.reference}) }}">Retour à mon projet</a></p>
    {% endif %}
  
    {% if  quotation.status == constant('\\AppBundle\\Entity\\Quotation::STATUS_DISPATCHED') or  quotation.status == constant('\\AppBundle\\Entity\\Quotation::STATUS_ACCEPTED') %}    
    
    <div class="row">
        <div class="col-sm-3">Référence interne :</div>
        <div class="col-sm-9">{{ quotation.internalReference }}</div>
    </div>
    <div class="row">
        <div class="col-sm-3">Mission :</div>
        <div class="col-sm-9">{{ quotation.description|nl2br }}</div>
    </div>
    <div class="row">
        <div class="col-sm-3">Délai de prodution :</div>
        <div class="col-sm-9">{{ quotation.productionTime }} jour(s)</div>
    </div><br>
    <table class="table table-striped table-hover">
        <thead>
            <tr>
                <th><strong>#</strong></th>
                <th><strong>Détail de la prestation</strong></th>
                <th class="text-center"><strong>Quantité</strong></th>
                <th class="text-right"><strong>PU HT</strong></th>
                <th class="text-right"><strong>TOTAL HT</strong></th>
            </tr>
        </thead>
        <tbody>
            {% for line in quotation.lines %}
                <tr>
                <td><strong>{{ line.number }}</strong></td>
                <td><strong>{{ line.description }}</strong></td>
                <td class="text-center"><strong>{{ line.quantity }}</strong></td>
                <td class="text-right"><strong>{{ line.price / 100 }}</strong></td>
                <td class="text-right"><strong>{{ (line.quantity * line.price) / 100 }} €</strong></td>
                </tr>
            {% endfor %}
        <tr>
            <td colspan="5"></td>
        </tr>
        <tr>
            <td colspan="4" class="text-right"><strong>TOTAL HT</strong></td>
            <td class="text-right"><strong>{{ (quotation.getTotalPrice / 100) | number_format(2) }} €</strong></td>
        </tr>
        <tr>
            <td colspan="4" class="text-right"><strong>TVA</strong></td>
            <td class="text-right"><strong>{{ (quotation.getVatPrice / 100) | number_format(2) }} €</strong></td>
        </tr>
        <tr>
            <td colspan="4" class="text-right"><strong>TOTAL TTC</strong></td>
            <td class="text-right"><strong>{{ ((quotation.getVatPrice + quotation.getTotalPrice) / 100) | number_format(2) }} €</strong></td>
        </tr>
        </tbody>
    </table>
    <hr class="hr-quotation">
    {% endif %}

    <div class="row">
        <div class="col-sm-6 text-left"> <h2>Échanges avec le maker</h2></div>  
    </div>

    <div class="row">
        <div class="col-sm-12">
            {% include 'front/common/quotation_messages.html.twig' with { 'isMaker': false } %}
        </div>
    </div>
    {# <p><a href="{{ path('quotation_maker_list') }}">Retour à mes devis reçus</a></p> #}
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script type="text/javascript">

        var $addLineLink = $('.add_line_link');
        var $newLinkLi = $('<div class="text-center"></div>').append($addLineLink);

        jQuery(document).ready(function() {
            // Get the ul that holds the collection of tags
           var $collectionHolder = $('div.lines');
            
            // add the "add a tag" anchor and li to the tags ul
            $('.lines').append($newLinkLi);
            
            // count the current form inputs we have (e.g. 2), use that as the new
            // index when inserting a new item (e.g. 2)
            $collectionHolder.data('index', $collectionHolder.find(':input').length);
            
            $addLineLink.on('click', function(e) {
                // prevent the link from creating a "#" on the URL
                e.preventDefault();
                
                // add a new tag form (see code block below)
                addLineForm($collectionHolder, $newLinkLi);
            });

            reCalculatePrice();

            // handle the removal, just for this example
            $('.remove-line').click(function(e) {
                e.preventDefault();

                $(this).parent().parent().remove();

                reIndexNumber();

                reCalculatePrice();
                    
                return false;
            });

            reIndexNumber();

            //Re-calculate price
            $('.type-field').on('input',function(e){

               reCalculatePrice();

            });
            
            
        });


        function reIndexNumber(){

            var i = 1;

            $('.index-line').each(function(e){

               $(this).val(e+1); 

            });

        }

        function reCalculatePrice(){

            console.log('Field change');

            var totalHt = 0;

            $('.line-number').each(function(e){

                var q = $(this).find('.quantity').val().replace(",", ".");

                var pu = $(this).find('.pu-ht').val().replace(",", ".");


                if(q == 0 || q == undefined || pu == 0 || pu == undefined){
                    var pt = 0;
                } else {
                    var pt = Number(q) * Number(pu);
                }

                totalHt += pt;
                
                console.log('line calc','Q :'+ q + ' PU : '+pu+' PT : '+pt);
                $(this).find('.total-line').val(pt.toFixed(2));

            });

            $('#div-total-ht').html('<strong>'+totalHt.toFixed(2)+' €</strong>');

            $('#div-vat').html('<strong>'+(totalHt*0.20).toFixed(2)+' €</strong>');

            $('#div-total-ttc').html('<strong>'+ (totalHt+(totalHt*0.20)).toFixed(2) +' €</strong>');


        }
    </script>
    {% include 'front/common/order_messages_js.html.twig' %}
{% endblock %}